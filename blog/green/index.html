<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Harry Aquije Ballon">
<meta name="dcterms.date" content="2025-10-28">

<title>What Does Green Access Look Like in Your City? – Harry Aquije Ballon</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-listing/list.min.js"></script>
<script src="../../site_libs/quarto-listing/quarto-listing.js"></script>
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-25b690a7babd8f4636ecd78d08a95595.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script>

  window.document.addEventListener("DOMContentLoaded", function (_event) {
    const listingTargetEl = window.document.querySelector('#listing-listing .list');
    if (!listingTargetEl) {
      // No listing discovered, do not attach.
      return; 
    }

    const options = {
      valueNames: ['listing-date','listing-title','listing-conference','listing-categories',{ data: ['index'] },{ data: ['categories'] },{ data: ['listing-date-sort'] },{ data: ['listing-file-modified-sort'] }],
      
      searchColumns: [],
    };

    window['quarto-listings'] = window['quarto-listings'] || {};
    window['quarto-listings']['listing-listing'] = new List('listing-listing', options);

    if (window['quarto-listing-loaded']) {
      window['quarto-listing-loaded']();
    }
  });

  window.addEventListener('hashchange',() => {
    if (window['quarto-listing-loaded']) {
      window['quarto-listing-loaded']();
    }
  })
  </script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-fixed fullcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Harry Aquije Ballon</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../talks/index.html"> <i class="bi bi-megaphone" role="img">
</i> 
<span class="menu-text">Talks</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog/index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../now/index.html"> 
<span class="menu-text">Now</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">What Does Green Access Look Like in Your City?</h1>
            <div class="quarto-categories">
                  <div class="quarto-category">geocomputation</div>
                  <div class="quarto-category">urban-policy</div>
                  <div class="quarto-category">green</div>
                  <div class="quarto-category">sustainability</div>
                  <div class="quarto-category">R</div>
              </div>
    </div>
  </div>

  <div class="quarto-title-meta">
          <div>
        <div class="quarto-title-meta-heading">Authors</div>
        <div class="quarto-title-meta-contents">
                      <p>Harry Aquije Ballon</p>
                  </div>
      </div>
        
          <div>
        <div class="quarto-title-meta-heading">Event Date</div>
        <div class="quarto-title-meta-contents">
          <p class="date">2025-10-28</p>
        </div>
      </div>
      </div>
</header>


<hr>
<section id="a-tale-of-two-cities" class="level2">
<h2 class="anchored" data-anchor-id="a-tale-of-two-cities">A Tale of Two Cities</h2>
<p>Having lived in London for the last four years, one of the things I appreciate most is the abundance of parks and green spaces. London consistently ranks among the top five cities globally for green coverage, depending on the methodology used. City planners around the world face the challenge of balancing productive and recreational land use — a balance that profoundly shapes the quality of urban life.</p>
<p>Throughout human history, our close relationship with nature has made access to green areas an essential component of modern living. These spaces provide environmental benefits such as improved air quality, social value through shared community spaces, and significant mental health benefits. Research also suggests that exposure to nature can enhance creativity and productivity. Green areas are not just leisure amenities — they are vital for sustainable, resilient, and liveable cities, playing a crucial role in mitigating the effects of climate change.</p>
<p>This project quantifies and maps green areas in London and Lima using OpenStreetMap (OSM) data. The goal is to estimate the total share of green areas and their distribution within each city as a proxy for inclusivity and accessibility. Both capitals share similarities in population size and area (Table 1), yet differ substantially in infrastructure, planning, and income levels — though these socioeconomic factors are beyond the focus of this study.</p>
<div class="table-captioned">
<p><em>Table 1: Demographic Comparison</em></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Dimension</th>
<th>Greater London</th>
<th>Metropolitan Lima</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Area</td>
<td>1,573 km²</td>
<td>2,819 km²</td>
</tr>
<tr class="even">
<td>Population (2025)</td>
<td>9.8 million</td>
<td>11.5 million</td>
</tr>
<tr class="odd">
<td>GDP per capita, PPP (2024)</td>
<td>$60,620</td>
<td>$17,802</td>
</tr>
</tbody>
</table>
<p><span style="font-size:0.8em;"> Notes: The GDP per capita (PPP, current international $) figures correspond to the United Kingdom for Greater London and Peru for Metropolitan Lima.<br>
Source: World Bank (2024); World Population Review (2025). </span></p>
</div>
</section>
<section id="data-and-methodology" class="level2">
<h2 class="anchored" data-anchor-id="data-and-methodology">Data and Methodology</h2>
<p>To calculate the share of green space, OpenStreetMap (OSM) data was used to extract green area polygons for both cities. For London, these polygons were combined with Natural England’s Green Belt data — a designated zone of open, undeveloped land encircling London, designed to limit urban sprawl and preserve open countryside.</p>
<p>Each dataset was spatially clipped to the official city boundaries: Lower Layer Super Output Areas (LSOAs) for London, obtained from the Office for National Statistics (ONS), and administrative districts (distritos) for Lima, from Peru’s National Institute of Statistics and Informatics (INEI). The analysis then computed the share of total green area as a percentage of each unit’s total land area using spatial intersection and area-weighted aggregation.</p>
</section>
<section id="results" class="level2">
<h2 class="anchored" data-anchor-id="results">Results</h2>
<p>The analysis finds that Greater London’s green area share is approximately <strong>33.6%</strong>, equivalent to 529 km² of land. This figure aligns with findings from Greenspace Information for Greater London (GiGL), which estimates that 33% of London’s area consists of natural habitats and an additional 14% is domestic garden space making a total of 47%. Despite this, access is not uniform — leafy boroughs in the southwest contrast sharply with denser urban areas where public green space is limited.</p>
<p>In comparison, Metropolitan Lima’s total green area share is <strong>11.3%</strong>, covering about 317 km². The spatial distribution of green areas is uneven: substantial parks and vegetated zones are concentrated in the south and some parts of the north, while much of the east — and large portions of the densely populated northern districts — show limited access to such spaces.</p>
<div class="talk-figure">
<div class="figure-title">

</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="glondon_lima_v1.png" class="talk-image img-fluid figure-img"></p>
<figcaption>Source: Map data from OpenStreetMap, ONS, INEI</figcaption>
</figure>
</div>
<section id="key-insights" class="level2">
<h2 class="anchored" data-anchor-id="key-insights">Key Insights</h2>
<ol type="1">
<li><strong>Equity of access matters as much as total coverage.</strong> While London’s 33.6% green share appears high, some boroughs still experience shortages in accessible public green space, often correlating with higher population density and lower income levels.</li>
<li><strong>Urban planning legacies shape outcomes.</strong> London’s protected Green Belt has been instrumental in preserving open land, but it also limits housing supply within the city, pushing development outward. Lima, on the other hand, has expanded rapidly with minimal zoning restrictions, resulting in fragmented and uneven green coverage.</li>
<li><strong>Socioeconomic disparities are visible on the map.</strong> In Lima, green areas tend to cluster around higher-income neighbourhoods and tourist zones, highlighting inequalities in urban amenities.</li>
<li><strong>Climate adaptation potential.</strong> Expanding and maintaining urban green areas can help mitigate heat stress, improve air quality, and enhance biodiversity — benefits particularly relevant to Lima’s arid coastal environment.</li>
</ol>
</section>
<section id="conclusions-and-policy-recommendations" class="level2">
<h2 class="anchored" data-anchor-id="conclusions-and-policy-recommendations">Conclusions and Policy Recommendations</h2>
<p>This comparative analysis underscores that both cities, despite their differences, face ongoing challenges in ensuring equitable access to nature within dense urban environments.</p>
<p>For London, maintaining and improving accessibility should remain a priority. Policymakers could focus on enhancing micro-green spaces, improving green corridors, and ensuring that new developments incorporate accessible public green areas.</p>
<p>For Lima, the challenge is more foundational: expanding green coverage, prioritising green infrastructure in urban planning, and promoting community-led initiatives to revitalise degraded public spaces. Integrating green design into housing and transport projects would also contribute to a more sustainable and liveable city.</p>
<p>Green spaces are essential urban infrastructure — not luxuries. They improve health, foster social connection, and build resilience to climate change. Whether in London, Lima, or elsewhere, increasing equitable access to green areas should be central to the vision of every modern city.</p>
</section>
<section id="interactive-maps" class="level2">
<h2 class="anchored" data-anchor-id="interactive-maps">Interactive Maps</h2>
<p>Beyond the numbers, visualising the spatial distribution of green spaces reveals the story more powerfully. While Greater London benefits from a wide network of parks, woodlands, and the surrounding Green Belt, Lima’s pattern highlights the urban and social challenges of providing equitable access to nature in a rapidly expanding metropolis.</p>
<p>The interactive maps below allow readers to explore these differences directly, zoom into neighbourhoods, compare patterns, and reflect on how green space accessibility shapes the liveability of each city.</p>
<section id="interactive-map-for-greater-london" class="level3">
<h3 class="anchored" data-anchor-id="interactive-map-for-greater-london">Interactive map for Greater London</h3>
<p>The interactive map below displays the share of green areas across neighbourhoods (Lower Layer Super Output Areas – LSOAs) in Greater London.<br>
Users can explore how access to green spaces varies spatially, from the central urban core to the surrounding areas covered by the Green Belt.</p>
<iframe src="london_green_share_lsoa.html" width="100%" height="650px" style="border:none;" title="Interactive map of green area share by LSOA in Greater London">
</iframe>
<p><span style="font-size:0.9em;"> <em>Source: OpenStreetMap, ONS, Natural England (Green Belt). Author’s analysis.</em> </span> —</p>
</section>
<section id="interactive-map-for-metropolitan-lima" class="level3">
<h3 class="anchored" data-anchor-id="interactive-map-for-metropolitan-lima">Interactive map for Metropolitan Lima</h3>
<p>This interactive map shows the proportion of green areas by district in Metropolitan Lima.<br>
It highlights the uneven distribution of green spaces across the city, where some districts have extensive green coverage while others have very limited access.</p>
<iframe src="lima_green_share_district.html" width="100%" height="650px" style="border:none;" title="Interactive map of green area share by district in Metropolitan Lima">
</iframe>
<p><span style="font-size:0.9em;"> <em>Source: OpenStreetMap, INEI. Author’s analysis.</em> </span></p>
</section>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<ul>
<li>Office for National Statistics (ONS). (2024). <em>Local Authority Districts (May 2024) Boundaries UK (BGC)</em>. ONS Geoportal. https://geoportal.statistics.gov.uk/<br>
</li>
<li>Natural England. (2023). <em>Green Belt boundaries (England)</em>. GOV.UK / data.gov.uk.<br>
</li>
<li>Instituto Nacional de Estadística e Informática (INEI). (2023). <em>Límites distritales del Perú</em> (District boundaries).<br>
</li>
<li>OpenStreetMap contributors. (2025). <em>OpenStreetMap planet dump</em>. Available under the Open Database License (ODbL). https://www.openstreetmap.org/copyright<br>
</li>
<li>Greenspace Information for Greater London (GiGL). (2018). <em>Mapping London’s Green Belt and Metropolitan Open Land</em> (blog / dataset).<br>
</li>
<li>World Bank. (2024). World Development Indicators.<br>
</li>
<li>World Population Review. (2025). Population estimates.</li>
</ul>
<p><strong>Data licences &amp; notes:</strong><br>
- OpenStreetMap data are provided under the <em>Open Database License (ODbL)</em>. Users may copy, modify, and publish OSM-derived data provided derivative data are shared under the same licence and attribution is given.<br>
- ONS and Natural England datasets are subject to their respective terms of use — please consult the original data portals for licence details.</p>
<p><strong>Code &amp; reproducibility:</strong><br>
All analysis code, processing scripts and the instructions to reproduce the maps are available on GitHub: <a href="https://github.com/harryaquije/green_cities">green_cities repository</a>.</p>



</section>
</div>
</section>

<div class="quarto-listing quarto-listing-container-default" id="listing-listing">
<div class="list quarto-listing-default">

</div>
<div class="listing-no-matching d-none">No matching items</div>
</div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/harryaquijeballon\.com");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>